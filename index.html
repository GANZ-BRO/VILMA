<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matematika gyakorl√°s</title>
  <meta name="description" content="Gyakorold a matematik√°t kateg√≥ri√°k √©s neh√©zs√©gi szintek szerint, s√∂t√©t/vil√°gos t√©m√°s feladatsorral!">
  <style>
    /* ... (a st√≠lusokat nem ford√≠tom le, azok technikaiak) ... */
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Matematika gyakorl√°s</h1>
      <button id="theme-toggle" aria-label="T√©ma v√°lt√°sa">üåó</button>
    </header>
    <div class="settings">
      <label for="category">Kateg√≥ria:
        <select id="category">
          <option value="√ñsszead√°s">√ñsszead√°s</option>
          <option value="Kivon√°s">Kivon√°s</option>
          <option value="Szorz√°s">Szorz√°s</option>
          <option value="Oszt√°s">Oszt√°s</option>
          <option value="Mind a n√©gy m≈±velet">Mind a n√©gy m≈±velet</option>
          <option value="Z√°r√≥jeles kifejez√©sek">Z√°r√≥jeles kifejez√©sek</option>
          <option value="T√∂rtek">T√∂rtek</option>
          <option value="Sz√°zal√©ksz√°m√≠t√°s">Sz√°zal√©ksz√°m√≠t√°s</option>
          <option value="Egyenletek √°trendez√©se">Egyenletek √°trendez√©se</option>
        </select>
      </label>
      <label for="difficulty">Neh√©zs√©gi szint:
        <select id="difficulty">
          <option value="easy">K√∂nny≈±</option>
          <option value="medium">K√∂zepes</option>
          <option value="hard">Neh√©z</option>
        </select>
      </label>
      <button class="big-btn" id="start-btn">J√°t√©k ind√≠t√°sa</button>
    </div>
    <div class="game-stats">
      <span class="stat" id="timer">‚è±Ô∏è Id≈ë: 0 mp</span>
      <span class="stat" id="score">üèÖ Pontsz√°m: 0</span>
    </div>
    <div class="best" id="best-stats" style="display:none;"></div>
    <section id="quiz" aria-label="Feladatsor"></section>
    <button class="big-btn" id="restart-btn" style="display:none;">√öjraj√°tsz√°s</button>
  </main>
  <script>
    // --- ALAPBE√ÅLL√çT√ÅSOK ---
    const QUESTIONS = 10;
    const DIFFICULTY_SETTINGS = {
      easy: { min: 0, max: 10 },
      medium: { min: -10, max: 20 },
      hard: { min: -50, max: 50 }
    };
    const implemented = [
      "√ñsszead√°s", "Kivon√°s", "Szorz√°s", "Oszt√°s", "Mind a n√©gy m≈±velet"
    ];

    // --- HTML ELEMEK ---
    const quizContainer = document.getElementById("quiz");
    const timerDisplay = document.getElementById("timer");
    const scoreDisplay = document.getElementById("score");
    const bestStats = document.getElementById("best-stats");
    const difficultySelect = document.getElementById("difficulty");
    const categorySelect = document.getElementById("category");
    const startBtn = document.getElementById("start-btn");
    const restartBtn = document.getElementById("restart-btn");
    const themeToggle = document.getElementById("theme-toggle");

    // --- √ÅLLAPOTV√ÅLTOZ√ìK ---
    let score = 0, startTime = 0, timerInterval = null, currentQuestion = 0, questions = [];
    let best = { score: 0, time: null };
    let gameActive = false;

    // --- LEGJOBB EREDM√âNY MENT√âSE/BET√ñLT√âSE ---
    function loadBest() {
      const diff = difficultySelect.value;
      const cat = categorySelect.value;
      try {
        const bestRaw = localStorage.getItem("vilma-best-" + cat + "-" + diff);
        best = bestRaw ? JSON.parse(bestRaw) : { score: 0, time: null };
      } catch { best = { score: 0, time: null }; }
      showBest();
    }
    function saveBest(newScore, time) {
      const diff = difficultySelect.value;
      const cat = categorySelect.value;
      if (newScore > best.score || (newScore === best.score && (best.time === null || time < best.time))) {
        best = { score: newScore, time: time };
        localStorage.setItem("vilma-best-" + cat + "-" + diff, JSON.stringify(best));
        showBest();
      }
    }
    function showBest() {
      if (best.score > 0) {
        bestStats.innerHTML = `üèÜ <b>Legjobb eredm√©ny:</b> ${best.score} pont, ${best.time} mp (${categoryLabel()} / ${difficultyLabel()})`;
        bestStats.style.display = "";
      } else {
        bestStats.style.display = "none";
      }
    }
    function difficultyLabel() {
      switch(difficultySelect.value) {
        case "easy": return "K√∂nny≈±";
        case "medium": return "K√∂zepes";
        case "hard": return "Neh√©z";
        default: return "";
      }
    }
    function categoryLabel() {
      return categorySelect.options[categorySelect.selectedIndex].textContent;
    }

    // --- T√âMA V√ÅLT√ÅS ---
    function applyTheme() {
      const dark = localStorage.getItem("vilma-theme") !== "light";
      document.body.classList.toggle("light", !dark);
    }
    themeToggle.addEventListener("click", function() {
      const isLight = document.body.classList.contains("light");
      localStorage.setItem("vilma-theme", isLight ? "dark" : "light");
      applyTheme();
    });
    applyTheme();

    // --- NEH√âZS√âG √âS KATEG√ìRIA KEZEL√âSE ---
    difficultySelect.addEventListener("change", loadBest);
    categorySelect.addEventListener("change", loadBest);

    // --- ID≈êZ√çT≈ê ---
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = `‚è±Ô∏è Id≈ë: ${elapsed} mp`;
    }

    // --- FELADATSOR GENER√ÅL√ÅSA ---
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function generateQuestions() {
      const { min, max } = DIFFICULTY_SETTINGS[difficultySelect.value];
      const category = categorySelect.value;
      questions = [];
      for (let i = 0; i < QUESTIONS; i++) {
        let num1 = getRandomInt(min, max),
            num2 = getRandomInt(min, max),
            question = {}, answer;
        switch (category) {
          case "√ñsszead√°s":
            question = { num1, num2, operator: "+", answer: num1 + num2 };
            break;
          case "Kivon√°s":
            question = { num1, num2, operator: "-", answer: num1 - num2 };
            break;
          case "Szorz√°s":
            question = { num1, num2, operator: "√ó", answer: num1 * num2 };
            break;
          case "Oszt√°s":
            num2 = getRandomInt(1, max > 1 ? max : 10); // null√°val ne osszon
            answer = getRandomInt(min, max);
            question = { num1: num2 * answer, num2: num2, operator: "√∑", answer: answer };
            break;
          case "Mind a n√©gy m≈±velet":
            const ops = ["+", "-", "√ó", "√∑"];
            const op = ops[getRandomInt(0, 3)];
            if (op === "+") question = { num1, num2, operator: "+", answer: num1 + num2 };
            if (op === "-") question = { num1, num2, operator: "-", answer: num1 - num2 };
            if (op === "√ó") question = { num1, num2, operator: "√ó", answer: num1 * num2 };
            if (op === "√∑") {
              num2 = getRandomInt(1, max > 1 ? max : 10);
              answer = getRandomInt(min, max);
              question = { num1: num2 * answer, num2: num2, operator: "√∑", answer: answer };
            }
            break;
          default:
            question = { placeholder: true };
        }
        questions.push(question);
      }
    }

    // --- SZ√ÅMBILLENTY≈∞ZET ---
    function renderNumpad(answerState, onChange) {
      const keys = [
        '1','2','3',
        '4','5','6',
        '7','8','9',
        '-','0','‚Üê'
      ];
      const numpadDiv = document.createElement('div');
      numpadDiv.className = 'numpad';
      keys.forEach(key => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'numpad-btn';
        btn.textContent = key;
        btn.tabIndex = 0;
        btn.onclick = () => {
          if (key === '‚Üê') {
            answerState.value = answerState.value.slice(0, -1);
          } else if (key === '-') {
            if (!answerState.value.startsWith('-')) {
              answerState.value = '-' + answerState.value;
            } else {
              answerState.value = answerState.value.substring(1);
            }
          } else {
            answerState.value += key;
          }
          onChange(answerState.value);
        };
        numpadDiv.appendChild(btn);
      });
      return numpadDiv;
    }

    // --- J√ÅT√âK LOGIKA ---
    function showQuestion(index) {
      quizContainer.innerHTML = "";
      const category = categorySelect.value;
      if (index >= QUESTIONS) {
        finishGame();
        return;
      }
      // Ha a kateg√≥ria nincs implement√°lva, jelenjen meg egy √ºzenet
      if (!implemented.includes(category)) {
        quizContainer.innerHTML = `<div><b>Ez a kateg√≥ria m√©g fejleszt√©s alatt √°ll! Pr√≥b√°ld ki az alapm≈±veleteket.</b></div>`;
        restartBtn.style.display = "";
        startBtn.style.display = "";
        clearInterval(timerInterval);
        gameActive = false;
        return;
      }
      const q = questions[index];
      const div = document.createElement("div");
      div.innerHTML = `<label>${index + 1}. feladat: <b>${q.num1}</b> ${q.operator} <b>${q.num2}</b> = </label>`;
      let answerState = { value: "" };
      const answerView = document.createElement("div");
      answerView.className = "answer-view";
      answerView.textContent = "";
      div.appendChild(answerView);

      // Sz√°mbillenty≈±zet
      const numpad = renderNumpad(answerState, function(val) {
        answerView.textContent = val;
      });
      div.appendChild(numpad);

      // K√ºld√©s gomb
      const submitBtn = document.createElement("button");
      submitBtn.type = "button";
      submitBtn.className = "big-btn";
      submitBtn.textContent = "K√ºld√©s";
      submitBtn.onclick = () => {
        if (!gameActive) return;
        const val = answerState.value;
        if (val === "" || val === "-") {
          alert("√çrj be egy v√°laszt!");
          return;
        }
        if (parseInt(val, 10) === q.answer) {
          score++;
          scoreDisplay.textContent = `üèÖ Pontsz√°m: ${score}`;
          currentQuestion++;
          showQuestion(currentQuestion);
        } else {
          alert("Nem j√≥ v√°lasz, pr√≥b√°ld √∫jra!");
        }
      };
      div.appendChild(submitBtn);

      quizContainer.appendChild(div);
    }

    function startGame() {
      if (!implemented.includes(categorySelect.value)) {
        quizContainer.innerHTML = `<div><b>Ez a kateg√≥ria m√©g fejleszt√©s alatt √°ll! Pr√≥b√°ld ki az alapm≈±veleteket.</b></div>`;
        restartBtn.style.display = "";
        startBtn.style.display = "";
        bestStats.style.opacity = "1";
        return;
      }
      gameActive = true;
      score = 0;
      currentQuestion = 0;
      scoreDisplay.textContent = `üèÖ Pontsz√°m: 0`;
      generateQuestions();
      showQuestion(0);
      startTime = Date.now();
      updateTimer();
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      restartBtn.style.display = "none";
      startBtn.style.display = "none";
      bestStats.style.opacity = "0.55";
    }
    function finishGame() {
      gameActive = false;
      clearInterval(timerInterval);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = `‚è±Ô∏è Id≈ë: ${elapsed} mp (V√©ge)`;
      quizContainer.innerHTML = `<p style="font-size:1.2em;"><b>Gratul√°lok!</b> ${score} pontot szerezt√©l ${elapsed} m√°sodperc alatt.</p>`;
      saveBest(score, elapsed);
      restartBtn.style.display = "";
      startBtn.style.display = "";
      bestStats.style.opacity = "1";
    }
    restartBtn.onclick = startGame;
    startBtn.onclick = startGame;

    // --- IND√çT√ÅS ---
    loadBest();
  </script>
</body>
</html>

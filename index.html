<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matematika gyakorl√°s</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <meta name="theme-color" content="#3578e5">
  <style>
    :root {
      --bg-dark: #121212; --text-dark: #f1f1f1; --input-bg-dark: #1e1e1e; --input-text-dark: #f1f1f1; --input-border-dark: #444;
      --bg-light: #f1f1f1; --text-light: #121212; --input-bg-light: #fff; --input-text-light: #121212; --input-border-light: #ccc;
      --primary: #3578e5; --primary-dark: #2851a3; --success: #4bb543;
      --submit-btn-bg: #52aaff; /* vil√°gosk√©k */
      --submit-btn-bg-hover: #199cff;
    }
    body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg-dark); color: var(--text-dark); min-height: 100vh; transition: background 0.3s, color 0.3s;}
    body.light { background: var(--bg-light); color: var(--text-light);}
    main { max-width: 440px; margin: auto; padding: 1em;}
    header { display: flex; align-items: center; justify-content: space-between; gap: 0.5em; flex-wrap: wrap;}
    h1 { font-size: 1.4em; margin: 0;}
    .settings { display: flex; gap: 0.6em; flex-wrap: wrap; margin: 1em 0; align-items: center; justify-content: space-between;}
    .settings label { font-size: 1em; font-weight: 500;}
    select { font-size: 1.05em; padding: 0.5em; border-radius: 6px; border: 1px solid var(--input-border-dark); background: var(--input-bg-dark); color: var(--input-text-dark); margin-top: 4px; transition: background 0.3s, color 0.3s, border 0.3s;}
    body.light select { background: var(--input-bg-light); color: var(--input-text-light); border: 1px solid var(--input-border-light);}
    .game-stats { display: flex; flex-wrap: wrap; gap: 1em; align-items: center; justify-content: space-between; margin-bottom: 1em;}
    .stat { font-weight: bold; font-size: 1.05em;}
    .best { font-size: 0.98em; color: var(--success); margin-top: 0.25em;}
    #quiz > div { margin-bottom: 18px; border-radius: 8px; padding: 1em; background: rgba(0,0,0,0.05); box-shadow: 0 2px 8px 0 rgba(0,0,0,0.05);}
    body.light #quiz > div { background: rgba(0,0,0,0.01); box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);}
    label { font-size: 1.08em; display: block; margin-bottom: 0.4em;}
    .answer-view { width: 80%; font-size: 1.25em; padding: 0.4em 0.7em; border-radius: 6px; border: 1px solid var(--input-border-dark); background: var(--input-bg-dark); color: var(--input-text-dark);}
    body.light .answer-view { background: var(--input-bg-light); color: var(--input-text-light); border: 1px solid var(--input-border-light);}
    .big-btn, button { display: inline-block; font-size: 1.2em; padding: 0.7em 1.3em; border: none; border-radius: 9px; margin: 0.5em 0 0.5em 0; background: var(--primary); color: #fff; font-weight: 600; cursor: pointer; transition: background 0.2s;}
    button:hover, .big-btn:hover, button:focus, .big-btn:focus { background: var(--primary-dark); outline: none;}
    #theme-toggle { font-size: 1.4em; border-radius: 50%; width: 2.3em; height: 2.3em; padding: 0; background: none; color: inherit; box-shadow: none; border: 2px solid currentColor; margin: 0;}
    .numpad-row { display: flex; gap: 0.5em; margin-bottom: 0.5em; width: 100%;}
    .numpad {
      display: flex;
      flex-direction: column;
      gap: 0.1em;
      margin-top: 0.7em;
      justify-content: flex-start;
      width: 100%;
      max-width: 340px;
      min-width: 220px;
    }
    .numpad-btn,
    .numpad-submit-btn {
      flex: 1 1 0;
      width: 100%;
      min-width: 0;
      aspect-ratio: 1/1;
      font-size: 1.25em;
      border-radius: 0.5em;
      border: none;
      background: var(--input-bg-dark);
      color: var(--input-text-dark);
      border: 1px solid var(--input-border-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background 0.2s, color 0.2s;
      max-height: 4em;
    }
    body.light .numpad-btn, body.light .numpad-submit-btn {
      background: var(--input-bg-light); color: var(--input-text-light); border: 1px solid var(--input-border-light);
    }
    .numpad-btn:active, .numpad-btn:focus, .numpad-submit-btn:active, .numpad-submit-btn:focus {
      background: var(--primary); color: #fff; outline: none;
    }
    .numpad-container { display: flex; flex-direction: column; align-items: flex-start; gap: 1.1em; width: 100%; }
    .numpad-submit-btn {
      background: var(--submit-btn-bg);
      color: #fff;
      border: 1px solid #199cff;
    }
    .numpad-submit-btn:hover, .numpad-submit-btn:focus { background: var(--submit-btn-bg-hover); outline: none;}
    .numpad-submit-btn > span {
      display: block;
      width: 100%;
      height: 100%;
      text-align: center;
      font-size: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      margin: 0;
      padding: 0;
    }
    @media (max-width: 600px) {
      main { padding: 0.5em;}
      h1 { font-size: 1.1em;}
      .settings { flex-direction: column; gap: 0.3em;}
      .game-stats { flex-direction: column; gap: 0.3em;}
      .big-btn, button { width: 100%; }
      .numpad { max-width: 100%; min-width: 0; }
      .numpad-row { gap: 0.2em; }
      .numpad-btn, .numpad-submit-btn {
        font-size: 1.05em;
        max-height: 2.6em;
      }
    }
    #quiz > div > label { font-size: 1.5em; font-weight: bold; }
    #theme-toggle { font-size: 1em; width: 1.8em; height: 1.8em; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Matematika gyakorl√°s</h1>
      <button id="theme-toggle" aria-label="T√©ma v√°lt√°sa">üåó</button>
    </header>
    <div class="settings">
      <label for="category">Kateg√≥ria:
        <select id="category">
          <option value="√ñsszead√°s">√ñsszead√°s</option>
          <option value="Kivon√°s">Kivon√°s</option>
          <option value="Szorz√°s">Szorz√°s</option>
          <option value="Oszt√°s">Oszt√°s</option>
          <option value="Mind a n√©gy m≈±velet">Mind a n√©gy m≈±velet</option>
          <option value="Z√°r√≥jeles kifejez√©sek">Z√°r√≥jeles kifejez√©sek</option>
          <option value="T√∂rtek">T√∂rtek</option>
          <option value="Sz√°zal√©ksz√°m√≠t√°s">Sz√°zal√©ksz√°m√≠t√°s</option>
          <option value="Egyenletek √°trendez√©se">Egyenletek √°trendez√©se</option>
        </select>
      </label>
      <label for="difficulty">Neh√©zs√©gi szint:
        <select id="difficulty">
          <option value="easy">K√∂nny≈±</option>
          <option value="medium">K√∂zepes</option>
          <option value="hard">Neh√©z</option>
        </select>
      </label>
      <button class="big-btn" id="start-btn">J√°t√©k ind√≠t√°sa</button>
    </div>
    <div class="game-stats">
      <span class="stat" id="timer">‚è±Ô∏è Id≈ë: 0 mp</span>
      <span class="stat" id="score">üèÖ Pontsz√°m: 0</span>
    </div>
    <div class="best" id="best-stats" style="display:none;"></div>
    <section id="quiz" aria-label="Feladatsor"></section>
    <button class="big-btn" id="restart-btn" style="display:none;">√öjraj√°tsz√°s</button>
  </main>
  <script>
    // --- ALAPBE√ÅLL√çT√ÅSOK ---
    const QUESTIONS = 10;
    const DIFFICULTY_SETTINGS = {
      easy: { min: 0, max: 10 },
      medium: { min: -10, max: 20 },
      hard: { min: -50, max: 50 }
    };

    // --- HTML ELEMEK ---
    const quizContainer = document.getElementById("quiz");
    const timerDisplay = document.getElementById("timer");
    const scoreDisplay = document.getElementById("score");
    const bestStats = document.getElementById("best-stats");
    const difficultySelect = document.getElementById("difficulty");
    const categorySelect = document.getElementById("category");
    const startBtn = document.getElementById("start-btn");
    const restartBtn = document.getElementById("restart-btn");
    const themeToggle = document.getElementById("theme-toggle");

    // --- √ÅLLAPOTV√ÅLTOZ√ìK ---
    let score = 0, startTime = 0, timerInterval = null, currentQuestion = 0, questions = [];
    let best = { score: 0, time: null };
    let gameActive = false;

    // --- LEGJOBB EREDM√âNY MENT√âSE/BET√ñLT√âSE ---
    function loadBest() {
      const diff = difficultySelect.value;
      const cat = categorySelect.value;
      try {
        const bestRaw = localStorage.getItem("vilma-best-" + cat + "-" + diff);
        best = bestRaw ? JSON.parse(bestRaw) : { score: 0, time: null };
      } catch { best = { score: 0, time: null }; }
      showBest();
    }
    function saveBest(newScore, time) {
      const diff = difficultySelect.value;
      const cat = categorySelect.value;
      if (newScore > best.score || (newScore === best.score && (best.time === null || time < best.time))) {
        best = { score: newScore, time: time };
        localStorage.setItem("vilma-best-" + cat + "-" + diff, JSON.stringify(best));
        showBest();
      }
    }
    function showBest() {
      if (best.score > 0) {
        bestStats.innerHTML = `üèÜ <b>Legjobb eredm√©ny:</b> ${best.score} pont, ${best.time} mp (${categoryLabel()} / ${difficultyLabel()})`;
        bestStats.style.display = "";
      } else {
        bestStats.style.display = "none";
      }
    }
    function difficultyLabel() {
      switch(difficultySelect.value) {
        case "easy": return "K√∂nny≈±";
        case "medium": return "K√∂zepes";
        case "hard": return "Neh√©z";
        default: return "";
      }
    }
    function categoryLabel() {
      return categorySelect.options[categorySelect.selectedIndex].textContent;
    }

    // --- T√âMA V√ÅLT√ÅS ---
    function applyTheme() {
      const dark = localStorage.getItem("vilma-theme") !== "light";
      document.body.classList.toggle("light", !dark);
    }
    themeToggle.addEventListener("click", function() {
      const isLight = document.body.classList.contains("light");
      localStorage.setItem("vilma-theme", isLight ? "dark" : "light");
      applyTheme();
    });
    applyTheme();

    // --- NEH√âZS√âG √âS KATEG√ìRIA KEZEL√âSE ---
    difficultySelect.addEventListener("change", loadBest);
    categorySelect.addEventListener("change", loadBest);

    // --- ID≈êZ√çT≈ê ---
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = `‚è±Ô∏è Id≈ë: ${elapsed} mp`;
    }

    // --- FELADATSOR GENER√ÅL√ÅSA ---
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
    function simplifyFraction(num, denom) {
      let d = gcd(Math.abs(num), Math.abs(denom));
      return [num/d, denom/d];
    }
    function generateQuestions() {
      const { min, max } = DIFFICULTY_SETTINGS[difficultySelect.value];
      const category = categorySelect.value;
      questions = [];
      for (let i = 0; i < QUESTIONS; i++) {
        let q = {};
        switch (category) {
          case "√ñsszead√°s":
            {
              let num1 = getRandomInt(min, max), num2 = getRandomInt(min, max);
              q = { num1, num2, operator: "+", answer: num1 + num2, display: `<b>${num1}</b> + <b>${num2}</b>` };
            }
            break;
          case "Kivon√°s":
            {
              let num1 = getRandomInt(min, max), num2 = getRandomInt(min, max);
              q = { num1, num2, operator: "-", answer: num1 - num2, display: `<b>${num1}</b> - <b>${num2}</b>` };
            }
            break;
          case "Szorz√°s":
            {
              let num1 = getRandomInt(min, max), num2 = getRandomInt(min, max);
              q = { num1, num2, operator: "√ó", answer: num1 * num2, display: `<b>${num1}</b> √ó <b>${num2}</b>` };
            }
            break;
          case "Oszt√°s":
            {
              // eg√©sz sz√°m√∫ eredm√©ny
              let num2 = getRandomInt(1, max > 1 ? max : 10);
              let answer = getRandomInt(min, max);
              q = { num1: num2 * answer, num2: num2, operator: "√∑", answer: answer, display: `<b>${num2*answer}</b> √∑ <b>${num2}</b>` };
            }
            break;
          case "Mind a n√©gy m≈±velet":
            {
              const ops = ["+", "-", "√ó", "√∑"];
              const op = ops[getRandomInt(0, 3)];
              let num1 = getRandomInt(min, max), num2 = getRandomInt(min, max);
              if (op === "+") q = { num1, num2, operator: "+", answer: num1 + num2, display: `<b>${num1}</b> + <b>${num2}</b>` };
              if (op === "-") q = { num1, num2, operator: "-", answer: num1 - num2, display: `<b>${num1}</b> - <b>${num2}</b>` };
              if (op === "√ó") q = { num1, num2, operator: "√ó", answer: num1 * num2, display: `<b>${num1}</b> √ó <b>${num2}</b>` };
              if (op === "√∑") {
                let num2 = getRandomInt(1, max > 1 ? max : 10);
                let answer = getRandomInt(min, max);
                q = { num1: num2 * answer, num2: num2, operator: "√∑", answer: answer, display: `<b>${num2*answer}</b> √∑ <b>${num2}</b>` };
              }
            }
            break;
          case "Z√°r√≥jeles kifejez√©sek":
            {
              // (a + b) * c vagy (a - b) * c
              let a = getRandomInt(min, max), b = getRandomInt(min, max), c = getRandomInt(1, 10), op = Math.random() > 0.5 ? "+" : "-";
              let inner = op === "+" ? a + b : a - b;
              q = {
                display: `(${a} ${op} ${b}) √ó ${c}`,
                answer: inner * c
              };
            }
            break;
          case "T√∂rtek":
            {
              // egyszer≈± t√∂rt √∂sszead√°s: a/b + c/d
              let b = getRandomInt(2, 8), d = getRandomInt(2, 8);
              let a = getRandomInt(1, b - 1), c = getRandomInt(1, d - 1);
              let numerator = a * d + c * b;
              let denominator = b * d;
              let [num, denom] = simplifyFraction(numerator, denominator);
              q = {
                display: `${a}/${b} + ${c}/${d}`,
                answer: `${num}/${denom}`
              };
            }
            break;
          case "Sz√°zal√©ksz√°m√≠t√°s":
            {
              // "Mennyi 25%-a 160-nak?"
              let percent = [10, 20, 25, 50, 75][getRandomInt(0, 4)];
              let base = getRandomInt(20, 200);
              let result = Math.round(base * percent / 100);
              q = {
                display: `Mennyi ${percent}% <b>${base}</b>-nak/nek?`,
                answer: result
              };
            }
            break;
          case "Egyenletek √°trendez√©se":
            {
              // Pl. 2x + 3 = 9
              let x = getRandomInt(-10, 10), a = getRandomInt(1, 5), b = getRandomInt(-10, 10);
              let result = a * x + b;
              q = {
                display: `${a}x ${b >= 0 ? "+" : "-"} ${Math.abs(b)} = ${result}. x = ?`,
                answer: x
              };
            }
            break;
          default: q = { display: "Hiba: kateg√≥ria nincs implement√°lva", answer: null };
        }
        questions.push(q);
      }
    }

    // --- SZ√ÅMBILLENTY≈∞ZET ---
    function renderNumpad(answerState, onChange) {
      // √öj elrendez√©s:
      // 1 2 3 4 ‚Üê
      // 5 6 7 8 ‚èé
      // 9 - 0 . /
      const rows = [
        ['1','2','3','4','‚Üê'],
        ['5','6','7','8','submit'],
        ['9','-','0','.','/']
      ];
      const numpadDiv = document.createElement('div');
      numpadDiv.className = 'numpad';

      rows.forEach((row, rowIndex) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'numpad-row';
        row.forEach((key, colIndex) => {
          if (key === 'submit') {
            const enterIcon = `<svg viewBox="0 0 48 48" width="1.2em" height="1.2em" style="display:block;margin:auto;" aria-hidden="true" focusable="false"><path d="M40 6v23H14.83l6.58-6.59L19 20l-10 10 10 10 2.41-2.41L14.83 31H44V6z" fill="currentColor"/></svg>`;
            const submitBtn = document.createElement("button");
            submitBtn.type = "button";
            submitBtn.className = "numpad-btn numpad-submit-btn";
            submitBtn.setAttribute("aria-label", "K√ºld√©s (Enter)");
            submitBtn.innerHTML = `<span>${enterIcon}</span>`;
            submitBtn.onclick = () => {
              if (!gameActive) return;
              let val = answerState.value.trim();
              if (val === "" || val === "-") {
                alert("√çrj be egy v√°laszt!");
                return;
              }
              let correct = false;
              // T√∂rtek eset√©n sz√∂veges √∂sszehasonl√≠t√°s
              if (categorySelect.value === "T√∂rtek") {
                let [ansNum, ansDen] = (questions[currentQuestion] || {}).answer?.split('/').map(Number);
                let [userNum, userDen] = val.split('/').map(Number);
                if (userNum && userDen) {
                  // Egyszer≈±s√≠t√ºnk
                  let [simpUserNum, simpUserDen] = simplifyFraction(userNum, userDen);
                  if (simpUserNum === ansNum && simpUserDen === ansDen) correct = true;
                }
              } else if (categorySelect.value === "Z√°r√≥jeles kifejez√©sek" || categorySelect.value === "Egyenletek √°trendez√©se") {
                if (parseFloat(val) === (questions[currentQuestion] || {}).answer) correct = true;
              } else if (categorySelect.value === "Sz√°zal√©ksz√°m√≠t√°s") {
                if (parseFloat(val) === (questions[currentQuestion] || {}).answer) correct = true;
              } else {
                if (parseFloat(val) === (questions[currentQuestion] || {}).answer) correct = true;
              }
              if (correct) {
                score++;
                scoreDisplay.textContent = `üèÖ Pontsz√°m: ${score}`;
                currentQuestion++;
                showQuestion(currentQuestion);
              } else {
                alert("Nem j√≥ v√°lasz, pr√≥b√°ld √∫jra!");
              }
            };
            rowDiv.appendChild(submitBtn);
          } else if (key !== '') {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'numpad-btn';
            btn.textContent = key;
            btn.tabIndex = 0;
            btn.onclick = () => {
              if (key === '‚Üê') {
                answerState.value = answerState.value.slice(0, -1);
              } else if (key === '-') {
                if (!answerState.value.startsWith('-')) {
                  answerState.value = '-' + answerState.value;
                } else {
                  answerState.value = answerState.value.substring(1);
                }
              } else if (key === '/') {
                if (!answerState.value.includes('/')) {
                  answerState.value += '/';
                }
              } else if (key === '.') {
                if (answerState.value !== "" && !answerState.value.includes('.')) {
                  answerState.value += '.';
                }
              } else {
                answerState.value += key;
              }
              onChange(answerState.value);
            };
            rowDiv.appendChild(btn);
          }
        });
        numpadDiv.appendChild(rowDiv);
      });
      return numpadDiv;
    }

    // --- J√ÅT√âK LOGIKA ---
    function showQuestion(index) {
      quizContainer.innerHTML = "";
      if (index >= QUESTIONS) {
        finishGame();
        return;
      }
      const q = questions[index];
      const div = document.createElement("div");
      div.innerHTML = `<label>${index + 1}. feladat: ${q.display} = </label>`;
      let answerState = { value: "" };
      const answerView = document.createElement("div");
      answerView.className = "answer-view";
      answerView.textContent = "";
      div.appendChild(answerView);

      // Sz√°mbillenty≈±zet panel (K√úLD√âS gomb a panelben, 8-as mellett)
      const numpad = renderNumpad(answerState, function(val) {
        answerView.textContent = val;
      });

      // Panel+gomb egy√ºtt (panel tartalmazza a submitot)
      const inputRow = document.createElement('div');
      inputRow.className = 'numpad-container';
      inputRow.appendChild(numpad);
      div.appendChild(inputRow);
      quizContainer.appendChild(div);
    }

    function startGame() {
      gameActive = true;
      score = 0;
      currentQuestion = 0;
      scoreDisplay.textContent = `üèÖ Pontsz√°m: 0`;
      generateQuestions();
      showQuestion(0);
      startTime = Date.now();
      updateTimer();
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      restartBtn.style.display = "none";
      startBtn.style.display = "none";
      bestStats.style.opacity = "0.55";
    }
    function finishGame() {
      gameActive = false;
      clearInterval(timerInterval);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = `‚è±Ô∏è Id≈ë: ${elapsed} mp (V√©ge)`;
      quizContainer.innerHTML = `<p style="font-size:1.2em;"><b>Gratul√°lok!</b> ${score} pontot szerezt√©l ${elapsed} m√°sodperc alatt.</p>`;
      saveBest(score, elapsed);
      restartBtn.style.display = "";
      startBtn.style.display = "";
      bestStats.style.opacity = "1";
    }
    restartBtn.onclick = startGame;
    startBtn.onclick = startGame;

    // --- IND√çT√ÅS ---
    loadBest();
  </script>
  <script>
    // Service worker regisztr√°l√°sa (OFFLINE m√≥dhoz)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker regisztr√°lva:', reg.scope))
          .catch(err => console.error('Service Worker hiba:', err));
      });
    }
  </script>
</body>
</html>